<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spite Projects - AI projects built out of spite</title>
  <meta name="description" content="A directory of open-source projects built out of spite against over-commercialization and unnecessary complexity.">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <h1><a href="/">Spite Projects</a></h1>
  </header>

  <main>
    <p class="tagline" style="color: #888; margin-bottom: 1.5rem; font-style: italic;">
      Projects built out of spite against over-commercialization and unnecessary complexity
    </p>

    <div class="filters">
      <input type="search" class="search-box" id="search" placeholder="Search projects...">
    </div>

    <div class="projects" id="projects">
      <p style="color: #666;">Loading projects...</p>
    </div>

    <div class="submit-section">
      <h2>Submit Your Spite Project</h2>
      <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">
        Add a <code>.spite</code> or <code>SPITE.md</code> file to your repo, then submit the URL below.
        <a href="https://github.com/Secret-Weapon-Group/spiteprojects-dot-com/blob/main/DESIGN-METADATA.md" target="_blank">See format</a>
      </p>
      <form id="submit-form">
        <input type="url" name="repoUrl" placeholder="Git repository URL (GitHub, GitLab, etc.)" required>
        <button type="submit">Submit Project</button>
      </form>
      <div id="message"></div>
    </div>
  </main>

  <footer>
    <a href="/terms.html">Terms</a> · <a href="/privacy.html">Privacy</a> ·
    <a href="https://github.com/Secret-Weapon-Group/spiteprojects-dot-com" target="_blank">GitHub</a>
  </footer>

  <script>
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function renderProject(p) {
      const links = [];
      if (p.repo) links.push(`<a href="${escapeHtml(p.repo)}" target="_blank" rel="noopener">Repo</a>`);
      if (p.web) links.push(`<a href="${escapeHtml(p.web)}" target="_blank" rel="noopener">Website</a>`);
      if (p.app?.android) links.push(`<a href="${escapeHtml(p.app.android)}" target="_blank" rel="noopener">Android</a>`);
      if (p.app?.ios) links.push(`<a href="${escapeHtml(p.app.ios)}" target="_blank" rel="noopener">iOS</a>`);

      const labels = (p.labels || []).slice(0, 3).map(l =>
        `<a href="/?label=${escapeHtml(l)}" class="label">${escapeHtml(l)}</a>`
      ).join('');

      const activityClass = p.activity || 'dormant';
      const activityLabel = {hot: 'Hot', active: 'Active', maintained: 'Maintained', dormant: 'Dormant'}[activityClass];

      const thumbHtml = p.thumbnail
        ? `<img src="${escapeHtml(p.thumbnail)}" alt="" class="project-thumb" loading="lazy">`
        : '';

      return `
        <div class="project-card ${p.thumbnail ? '' : 'no-thumb'}">
          ${thumbHtml}
          <div class="project-info">
            <h3>${escapeHtml(p.name)}</h3>
            <p class="description">${escapeHtml(p.description)}</p>
            <div class="project-meta">
              <span>by ${escapeHtml(p.author || 'anonymous')}</span>
              <span class="activity">
                <span class="activity-dot ${activityClass}"></span>
                ${activityLabel}
              </span>
            </div>
            <div class="labels">${labels}</div>
            <div class="project-links">${links.join('')}</div>
          </div>
        </div>
      `;
    }

    async function loadProjects() {
      const container = document.getElementById('projects');
      try {
        const res = await fetch('/api/projects');
        const projects = await res.json();

        if (projects.length === 0) {
          container.innerHTML = '<p style="color: #666;">No projects yet. Be the first to submit!</p>';
          return;
        }

        container.innerHTML = projects.map(renderProject).join('');
      } catch (err) {
        container.innerHTML = '<p style="color: #ff6b6b;">Failed to load projects</p>';
      }
    }

    // Search filter
    document.getElementById('search').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('.project-card').forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(query) ? '' : 'none';
      });
    });

    // Submit form
    document.getElementById('submit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const repoUrl = form.repoUrl.value;

      const msg = document.getElementById('message');
      msg.className = 'message';
      msg.textContent = 'Fetching project metadata...';

      try {
        const res = await fetch('/api/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ repoUrl })
        });

        const data = await res.json();

        if (res.ok) {
          msg.className = 'message success';
          msg.textContent = `Added: ${data.name}`;
          form.reset();
          loadProjects();
        } else {
          msg.className = 'message error';
          msg.textContent = data.error || 'Failed to add project';
        }
      } catch (err) {
        msg.className = 'message error';
        msg.textContent = 'Network error';
      }
    });

    loadProjects();
  </script>
</body>
</html>
